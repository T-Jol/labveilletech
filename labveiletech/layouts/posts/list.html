{{ define "title" }}
  Articles · {{ .Site.Title }}
{{ end }}
{{ define "content" }}
  <section class="container list">
    <header style="margin-top: 6.4rem; margin-bottom: 4rem;">
      <h1 class="title" style="font-size: 4.2rem; line-height: 4.6rem; margin: 0 0 1rem 0; font-weight: 700;">
        <a class="title-link" href="{{ .Permalink | safeURL }}" style="color: inherit; text-decoration: none;">
          Articles
        </a>
      </h1>
      <p style="font-size: 1.6rem; color: var(--fg-color); opacity: 0.7; margin: 0; font-weight: 400;">
        Par catégorie
      </p>
    </header>
    {{ if .Content }}
    <div style="margin-bottom: 3.2rem; font-size: 1.8rem; line-height: 1.8em; color: var(--fg-color);">
      {{ .Content }}
    </div>
    {{ end }}
    
    {{- $regularArticles := slice -}}
    {{- $formationArticles := slice -}}
    {{- $allCategories := slice -}}
    {{- range .Paginator.Pages -}}
      {{- if eq .Params.articleType "formation" -}}
        {{- $formationArticles = $formationArticles | append . -}}
      {{- else -}}
        {{- $regularArticles = $regularArticles | append . -}}
        {{- range .Params.categories -}}
          {{- $allCategories = $allCategories | append . -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- $uniqueCategories := $allCategories | uniq | sort -}}
    
    {{ if $regularArticles }}
    <div style="margin-bottom: 4.5rem; padding: 2rem; background-color: var(--alt-bg-color); border-radius: 12px; border: 1px solid var(--alt-bg-color);">
      <div style="margin-bottom: 1.8rem;">
        <h2 style="font-size: 1.9rem; font-weight: 600; color: var(--fg-color); margin: 0; opacity: 0.95;">
          Filtrer par catégorie
        </h2>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
        <button class="category-filter-btn category-filter-btn-all active" data-category="all" style="padding: 0.8rem 1.6rem; font-size: 1.4rem; font-weight: 500; color: var(--bg-color); background-color: var(--link-color); border: 2px solid var(--link-color); border-radius: 2rem; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          Tous
        </button>
        {{- range $uniqueCategories -}}
        <button class="category-filter-btn" data-category="{{ . | urlize }}" data-category-name="{{ . }}" style="padding: 0.8rem 1.6rem; font-size: 1.4rem; font-weight: 500; color: var(--fg-color); background-color: var(--bg-color); border: 1px solid var(--alt-bg-color); border-radius: 2rem; cursor: pointer; transition: all 0.2s ease;">
          {{ . }}
        </button>
        {{- end -}}
      </div>
      <div id="selected-categories-info" style="margin-top: 1.5rem; font-size: 1.4rem; color: var(--fg-color); opacity: 0.7; min-height: 2rem; font-weight: 500;">
      </div>
    </div>
    
    <ul id="regular-articles-list" style="list-style: none; padding: 0; margin: 0 0 4rem 0;">
      {{- range $regularArticles -}}
        {{- .Render "li" -}}
      {{- end }}
    </ul>
    
    <div id="load-more-container" style="text-align: center; margin: 5rem 0; display: none;">
      <button id="load-more-btn" style="padding: 1.5rem 4rem; font-size: 1.6rem; font-weight: 600; color: var(--bg-color); background-color: var(--link-color); border: none; border-radius: 1rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <span style="display: inline-flex; align-items: center; gap: 1rem;">
          Charger plus d'articles
          <i class="fa-solid fa-arrow-down" aria-hidden="true" style="font-size: 1.2rem; transition: transform 0.3s ease;"></i>
        </span>
      </button>
    </div>
    {{ end }}
    
    {{ if and $formationArticles $regularArticles }}
    <div style="margin: 6rem 0 4rem 0; padding: 3rem 0; border-top: 2px solid var(--alt-bg-color);">
      <h2 style="font-size: 2.6rem; font-weight: 700; color: var(--fg-color); margin-bottom: 2.5rem; opacity: 0.95;">
        Articles personnels
      </h2>
      <ul style="list-style: none; padding: 0; margin: 0;">
        {{- range $formationArticles -}}
          {{- .Render "li" -}}
        {{- end }}
      </ul>
    </div>
    {{ else if $formationArticles }}
    <ul style="list-style: none; padding: 0; margin: 0;">
      {{- range $formationArticles -}}
        {{- .Render "li" -}}
      {{- end }}
    </ul>
    {{ end }}
    
    {{ if and (not $regularArticles) (not $formationArticles) }}
    <ul style="list-style: none; padding: 0; margin: 0;">
      {{- range .Paginator.Pages -}}
        {{- .Render "li" -}}
      {{- end }}
    </ul>
    {{ end }}

    {{ partial "pagination.html" . }}
  </section>
  
  <style>
    .category-filter-btn {
      position: relative;
    }
    .category-filter-btn:hover:not(.active) {
      background-color: var(--alt-bg-color) !important;
      border-color: var(--link-color) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .category-filter-btn.active {
      background-color: var(--link-color) !important;
      color: var(--bg-color) !important;
      border-color: var(--link-color) !important;
      border-width: 2px !important;
      font-weight: 600 !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
    }
    .post-item {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    .post-item.hidden {
      display: none;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #load-more-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25) !important;
    }
    #load-more-btn:hover i {
      transform: translateY(2px);
    }
    #load-more-btn:active {
      transform: translateY(-1px);
    }
  </style>
  
  <script>
    (function() {
      const articles = document.querySelectorAll('#regular-articles-list .post-item');
      const filterButtons = document.querySelectorAll('.category-filter-btn');
      const allButton = document.querySelector('.category-filter-btn-all');
      const loadMoreContainer = document.getElementById('load-more-container');
      const loadMoreBtn = document.getElementById('load-more-btn');
      const selectedCategoriesInfo = document.getElementById('selected-categories-info');
      
      let selectedCategories = new Set(['all']);
      const visibleCount = 2;
      
      function updateSelectedCategoriesInfo() {
        if (selectedCategories.has('all') || selectedCategories.size === 0) {
          selectedCategoriesInfo.textContent = '';
          return;
        }
        const selectedNames = Array.from(selectedCategories).map(function(cat) {
          const btn = document.querySelector('.category-filter-btn[data-category="' + cat + '"]');
          return btn ? btn.getAttribute('data-category-name') : '';
        }).filter(Boolean);
        
        if (selectedNames.length > 0) {
          selectedCategoriesInfo.textContent = selectedNames.length === 1 
            ? 'Filtre actif : ' + selectedNames[0]
            : 'Filtres actifs : ' + selectedNames.join(', ');
        } else {
          selectedCategoriesInfo.textContent = '';
        }
      }
      
      function updateButtonStates() {
        filterButtons.forEach(function(btn) {
          const category = btn.getAttribute('data-category');
          if (selectedCategories.has(category)) {
            btn.classList.add('active');
            // Forcer les styles pour les boutons actifs
            btn.style.backgroundColor = 'var(--link-color)';
            btn.style.color = 'var(--bg-color)';
            btn.style.borderColor = 'var(--link-color)';
            btn.style.borderWidth = '2px';
            btn.style.fontWeight = '600';
          } else {
            btn.classList.remove('active');
            // Restaurer les styles par défaut pour les boutons inactifs
            btn.style.backgroundColor = 'var(--alt-bg-color)';
            btn.style.color = 'var(--fg-color)';
            btn.style.borderColor = 'var(--alt-bg-color)';
            btn.style.borderWidth = '1px';
            btn.style.fontWeight = '500';
          }
        });
      }
      
      function filterArticles() {
        let filteredArticles = [];
        
        articles.forEach(function(article) {
          const articleCategories = (article.getAttribute('data-categories') || '').trim().split(/\s+/);
          
          let shouldShow = false;
          
          if (selectedCategories.has('all') || selectedCategories.size === 0) {
            shouldShow = true;
          } else {
            // L'article doit avoir AU MOINS une des catégories sélectionnées
            shouldShow = articleCategories.some(function(cat) {
              return selectedCategories.has(cat.toLowerCase());
            });
          }
          
          if (shouldShow) {
            article.classList.remove('hidden');
            article.style.display = 'block';
            filteredArticles.push(article);
          } else {
            article.classList.add('hidden');
            article.style.display = 'none';
            article.classList.remove('hidden-by-count');
          }
        });
        
        // Afficher seulement les 2 premiers articles avec animation
        filteredArticles.forEach(function(article, index) {
          article.classList.remove('hidden-by-count');
          if (index >= visibleCount) {
            article.style.display = 'none';
            article.classList.add('hidden-by-count');
          } else {
            article.style.display = 'block';
            article.style.opacity = '0';
            article.style.transform = 'translateY(5px)';
            setTimeout(function() {
              article.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              article.style.opacity = '1';
              article.style.transform = 'translateY(0)';
            }, index * 30);
          }
        });
        
        // Afficher le bouton "Charger plus" s'il y a plus de 2 articles
        if (filteredArticles.length > visibleCount) {
          loadMoreContainer.style.display = 'block';
        } else {
          loadMoreContainer.style.display = 'none';
        }
      }
      
      // Gestion des clics sur les boutons de filtre
      filterButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const category = this.getAttribute('data-category');
          
          if (category === 'all') {
            // Si "Tous" est cliqué, désélectionner toutes les autres catégories
            selectedCategories.clear();
            selectedCategories.add('all');
          } else {
            // Si une catégorie spécifique est cliquée
            if (selectedCategories.has('all')) {
              selectedCategories.clear();
            }
            
            // Toggle la catégorie
            if (selectedCategories.has(category)) {
              selectedCategories.delete(category);
            } else {
              selectedCategories.add(category);
            }
            
            // Si aucune catégorie n'est sélectionnée, revenir à "Tous"
            if (selectedCategories.size === 0) {
              selectedCategories.add('all');
            }
          }
          
          updateButtonStates();
          updateSelectedCategoriesInfo();
          filterArticles();
        });
      });
      
      // Gestion du bouton "Charger plus"
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
          const hiddenArticles = document.querySelectorAll('#regular-articles-list .post-item.hidden-by-count:not(.hidden)');
          
          hiddenArticles.forEach(function(article) {
            article.style.display = 'block';
            article.style.opacity = '0';
            article.style.transform = 'translateY(5px)';
            article.classList.remove('hidden-by-count');
            setTimeout(function() {
              article.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              article.style.opacity = '1';
              article.style.transform = 'translateY(0)';
            }, 10);
          });
          
          loadMoreContainer.style.display = 'none';
        });
      }
      
      // Initialiser
      if (articles.length > 0) {
        updateButtonStates();
        filterArticles();
      }
    })();
  </script>
{{ end }}
